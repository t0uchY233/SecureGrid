# Архитектура приложения SecureGrid

## Общая схема

```
+------------------+        +-------------------+        +-------------------+
|                  |        |                   |        |                   |
|    Клиент        | <----> |     Сервер        | <----> |   База данных     |
|    (React)       |        |     (Node.js)     |        |   (PostgreSQL)    |
|                  |        |                   |        |                   |
+------------------+        +-------------------+        +-------------------+
       ^                           ^                            ^
       |                           |                            |
       |                           |                            |
       v                           v                            v
+------------------+        +-------------------+       +--------------------+
|                  |        |                   |       |                    |
|   Socket.io      | <----> |    Socket.io      |       |   Кэш вычислений   |
|   (Клиент)       |        |    (Сервер)       |       |   (Redis, опц.)    |
|                  |        |                   |       |                    |
+------------------+        +-------------------+       +--------------------+
```

## Принципы защиты данных

Основной принцип защиты в SecureGrid - разделение представления и логики. Клиент никогда не получает доступ к формулам и внутренней логике вычислений, а только к результатам:  

1. **Клиент** - отвечает только за представление данных и взаимодействие с пользователем
2. **Сервер** - хранит всю бизнес-логику, формулы, выполняет вычисления
3. **WebSocket** - служит для мгновенной синхронизации представления между клиентами

## Компоненты системы

### Клиентская часть

#### Основные модули фронтенда:

1. **UI компоненты**
   - Сетка таблицы (Grid)
   - Ячейки с различным форматированием
   - Панель инструментов
   - Диалоги и модальные окна

2. **Менеджеры состояний**
   - Хранение локального состояния таблицы
   - Очередь изменений для отправки на сервер
   - Управление выбором ячеек и навигацией

3. **Сетевые сервисы**
   - REST API клиент для обычных запросов
   - WebSocket клиент для real-time взаимодействия
   - Система обработки сетевых ошибок и переподключений

4. **Утилиты**
   - Форматирование данных для отображения
   - Проверка прав доступа
   - Вспомогательные функции для работы с ячейками и диапазонами

### Серверная часть

#### Основные модули бэкенда:

1. **API слой**
   - RESTful API контроллеры
   - Валидация входных данных
   - Аутентификация и авторизация

2. **Бизнес-логика**
   - Обработка операций с таблицами
   - Парсер и вычислитель формул
   - Менеджер совместной работы

3. **Слой доступа к данным**
   - Модели данных
   - Репозитории для работы с БД
   - Кэширование результатов вычислений

4. **WebSocket сервер**
   - Менеджер соединений
   - Обработчики событий
   - Процессор совместного редактирования

## Модели данных

### User (Пользователь)

```
+---------------+-------------+-------------------+
| Поле          | Тип         | Описание          |
+---------------+-------------+-------------------+
| id            | Integer     | Первичный ключ    |
| name          | String      | Имя пользователя  |
| email         | String      | Email             |
| password_hash | String      | Хеш пароля        |
| created_at    | Timestamp   | Дата создания     |
| updated_at    | Timestamp   | Дата обновления   |
+---------------+-------------+-------------------+
```

### Spreadsheet (Таблица)

```
+---------------+-------------+-------------------+
| Поле          | Тип         | Описание          |
+---------------+-------------+-------------------+
| id            | Integer     | Первичный ключ    |
| title         | String      | Название таблицы  |
| owner_id      | Integer     | ID создателя      |
| rows          | Integer     | Кол-во строк      |
| columns       | Integer     | Кол-во столбцов   |
| created_at    | Timestamp   | Дата создания     |
| updated_at    | Timestamp   | Дата обновления   |
+---------------+-------------+-------------------+
```

### Cell (Ячейка)

```
+---------------+-------------+-------------------+
| Поле          | Тип         | Описание          |
+---------------+-------------+-------------------+
| id            | Integer     | Первичный ключ    |
| spreadsheet_id| Integer     | ID таблицы        |
| row           | Integer     | Номер строки      |
| column        | Integer     | Номер столбца     |
| value         | Text        | Значение/формула  |
| type          | Enum        | Тип значения      |
| metadata      | JSON        | Метаданные        |
| created_at    | Timestamp   | Дата создания     |
| updated_at    | Timestamp   | Дата обновления   |
+---------------+-------------+-------------------+
```

### Permission (Разрешение)

```
+---------------+-------------+-------------------+
| Поле          | Тип         | Описание          |
+---------------+-------------+-------------------+
| id            | Integer     | Первичный ключ    |
| spreadsheet_id| Integer     | ID таблицы        |
| user_id       | Integer     | ID пользователя   |
| role          | Enum        | Роль (owner,      |
|               |             | editor, viewer)   |
| created_at    | Timestamp   | Дата создания     |
| updated_at    | Timestamp   | Дата обновления   |
+---------------+-------------+-------------------+
```

### AuditLog (Журнал аудита)

```
+---------------+-------------+-------------------+
| Поле          | Тип         | Описание          |
+---------------+-------------+-------------------+
| id            | Integer     | Первичный ключ    |
| user_id       | Integer     | ID пользователя   |
| spreadsheet_id| Integer     | ID таблицы        |
| action        | String      | Действие          |
| details       | JSON        | Детали действия   |
| created_at    | Timestamp   | Дата создания     |
+---------------+-------------+-------------------+
```

## Алгоритм разрешения конфликтов (OT)

Для разрешения конфликтов при одновременном редактировании используется упрощённая версия алгоритма Operational Transformation:

1. Каждое изменение ячейки представляется как операция с уникальным ID
2. Операции имеют временные метки и ID пользователя  
3. Сервер упорядочивает операции и применяет их в определённом порядке
4. При конфликтах применяются следующие правила:
   - Операция с более поздней временной меткой имеет приоритет
   - В случае одинаковых временных меток, используется приоритет по ID пользователя

## Система безопасности

1. **Аутентификация**:
   - JWT-токены для аутентификации
   - Хеширование паролей с использованием bcrypt
   - Возможность 2FA (в дорожной карте)

2. **Авторизация**:
   - Ролевая модель прав доступа
   - Детальные разрешения на уровне таблиц
   - Разграничение доступа на уровне API

3. **Защита данных**:
   - Шифрование данных в БД (для критичной информации)
   - SSL/TLS для всех соединений
   - Проверка на SQL-инъекции через ORM

4. **Аудит**:
   - Логирование всех действий пользователей
   - Отслеживание изменений на уровне ячеек
   - Журнал доступа к системе